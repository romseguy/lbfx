import {
  GeocodeResult,
  LatLon,
  Suggestion,
  getDetails,
  getGeocode,
  getLatLng
} from "use-places-autocomplete";

export type SizeMap = {
  defaultSize: {
    enabled: boolean;
  };
  fullSize: {
    enabled: boolean;
  };
};

export const markerIcons: {
  [key: string]: { paths: string[]; polygons?: string[]; viewBox: string };
} = {
  arrow: {
    //paths: ["M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"],
    paths: ["M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"],
    viewBox: "0 0 24 24"
  },
  event: {
    paths: [
      "M10.8889,5.5 L3.11111,5.5 L3.11111,7.05556 L10.8889,7.05556 L10.8889,5.5 Z M12.4444,1.05556 L11.6667,1.05556 L11.6667,0 L10.1111,0 L10.1111,1.05556 L3.88889,1.05556 L3.88889,0 L2.33333,0 L2.33333,1.05556 L1.55556,1.05556 C0.692222,1.05556 0.00777777,1.75556 0.00777777,2.61111 L0,12.5 C0,13.3556 0.692222,14 1.55556,14 L12.4444,14 C13.3,14 14,13.3556 14,12.5 L14,2.61111 C14,1.75556 13.3,1.05556 12.4444,1.05556 Z M12.4444,12.5 L1.55556,12.5 L1.55556,3.94444 L12.4444,3.94444 L12.4444,12.5 Z M8.55556,8.61111 L3.11111,8.61111 L3.11111,10.1667 L8.55556,10.1667 L8.55556,8.61111 Z"
    ],
    viewBox: "0 0 14 14"
  },
  org: {
    paths: [
      "M349.1 334.7c-11.2-4-29.5-4.2-37.6-7.3-5.6-2.2-14.5-4.6-17.4-8.1-2.9-3.5-2.9-28.5-2.9-28.5s7-6.6 9.9-14c2.9-7.3 4.8-27.5 4.8-27.5s6.6 2.8 9.2-10.4c2.2-11.4 6.4-17.4 5.3-25.8-1.2-8.4-5.8-6.4-5.8-6.4s5.8-8.5 5.8-37.4c0-29.8-22.5-59.1-64.6-59.1-42 0-64.7 29.4-64.7 59.1 0 28.9 5.7 37.4 5.7 37.4s-4.7-2-5.8 6.4c-1.2 8.4 3 14.4 5.3 25.8 2.6 13.3 9.2 10.4 9.2 10.4s1.9 20.1 4.8 27.5c2.9 7.4 9.9 14 9.9 14s0 25-2.9 28.5-11.8 5.9-17.4 8c-8 3.1-26.3 3.5-37.6 7.5-11.2 4-45.8 22.2-45.8 67.2h278.3c.1-45.1-34.5-63.3-45.7-67.3z",
      "M140 286s23.9-.8 33.4-9.3c-15.5-23.5-7.1-50.9-10.3-76.5-3.2-25.5-17.7-40.8-46.7-40.8h-.4c-28 0-43.1 15.2-46.3 40.8-3.2 25.5 5.7 56-10.2 76.5C69 285.3 93 285 93 285s1 14.4-1 16.8c-2 2.4-7.9 4.7-12 5.5-8.8 1.9-18.1 4.5-25.9 7.2-7.8 2.7-22.6 17.2-22.6 37.2h80.3c2.2-8 17.3-22.3 32-29.8 9-4.6 17.9-4.3 24.7-5.2 0 0 3.8-6-8.7-8.3 0 0-17.2-4.3-19.2-6.7-1.9-2.2-.6-15.7-.6-15.7zM372 286s-23.9-.8-33.4-9.3c15.5-23.5 7.1-50.9 10.3-76.5 3.2-25.5 17.7-40.8 46.7-40.8h.4c28 0 43.1 15.2 46.3 40.8 3.2 25.5-5.7 56 10.2 76.5-9.5 8.6-33.5 8.3-33.5 8.3s-1 14.4 1 16.8c2 2.4 7.9 4.7 12 5.5 8.8 1.9 18.1 4.5 25.9 7.2 7.8 2.7 22.6 17.2 22.6 37.2h-80.3c-2.2-8-17.3-22.3-32-29.8-9-4.6-17.9-4.3-24.7-5.2 0 0-3.8-6 8.7-8.3 0 0 17.2-4.3 19.2-6.7 1.9-2.2.6-15.7.6-15.7z"
    ],
    viewBox: "0 0 512 512"
  },
  planet: {
    paths: [
      "M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm200 248c0 22.5-3.9 44.2-10.8 64.4h-20.3c-4.3 0-8.4-1.7-11.4-4.8l-32-32.6c-4.5-4.6-4.5-12.1.1-16.7l12.5-12.5v-8.7c0-3-1.2-5.9-3.3-8l-9.4-9.4c-2.1-2.1-5-3.3-8-3.3h-16c-6.2 0-11.3-5.1-11.3-11.3 0-3 1.2-5.9 3.3-8l9.4-9.4c2.1-2.1 5-3.3 8-3.3h32c6.2 0 11.3-5.1 11.3-11.3v-9.4c0-6.2-5.1-11.3-11.3-11.3h-36.7c-8.8 0-16 7.2-16 16v4.5c0 6.9-4.4 13-10.9 15.2l-31.6 10.5c-3.3 1.1-5.5 4.1-5.5 7.6v2.2c0 4.4-3.6 8-8 8h-16c-4.4 0-8-3.6-8-8s-3.6-8-8-8H247c-3 0-5.8 1.7-7.2 4.4l-9.4 18.7c-2.7 5.4-8.2 8.8-14.3 8.8H194c-8.8 0-16-7.2-16-16V199c0-4.2 1.7-8.3 4.7-11.3l20.1-20.1c4.6-4.6 7.2-10.9 7.2-17.5 0-3.4 2.2-6.5 5.5-7.6l40-13.3c1.7-.6 3.2-1.5 4.4-2.7l26.8-26.8c2.1-2.1 3.3-5 3.3-8 0-6.2-5.1-11.3-11.3-11.3H258l-16 16v8c0 4.4-3.6 8-8 8h-16c-4.4 0-8-3.6-8-8v-20c0-2.5 1.2-4.9 3.2-6.4l28.9-21.7c1.9-.1 3.8-.3 5.7-.3C358.3 56 448 145.7 448 256zM130.1 149.1c0-3 1.2-5.9 3.3-8l25.4-25.4c2.1-2.1 5-3.3 8-3.3 6.2 0 11.3 5.1 11.3 11.3v16c0 3-1.2 5.9-3.3 8l-9.4 9.4c-2.1 2.1-5 3.3-8 3.3h-16c-6.2 0-11.3-5.1-11.3-11.3zm128 306.4v-7.1c0-8.8-7.2-16-16-16h-20.2c-10.8 0-26.7-5.3-35.4-11.8l-22.2-16.7c-11.5-8.6-18.2-22.1-18.2-36.4v-23.9c0-16 8.4-30.8 22.1-39l42.9-25.7c7.1-4.2 15.2-6.5 23.4-6.5h31.2c10.9 0 21.4 3.9 29.6 10.9l43.2 37.1h18.3c8.5 0 16.6 3.4 22.6 9.4l17.3 17.3c3.4 3.4 8.1 5.3 12.9 5.3H423c-32.4 58.9-93.8 99.5-164.9 103.1z"
    ],
    viewBox: "0 0 496 512"
  },
  tree: {
    paths: [
      "M378.31 378.49L298.42 288h30.63c9.01 0 16.98-5 20.78-13.06 3.8-8.04 2.55-17.26-3.28-24.05L268.42 160h28.89c9.1 0 17.3-5.35 20.86-13.61 3.52-8.13 1.86-17.59-4.24-24.08L203.66 4.83c-6.03-6.45-17.28-6.45-23.32 0L70.06 122.31c-6.1 6.49-7.75 15.95-4.24 24.08C69.38 154.65 77.59 160 86.69 160h28.89l-78.14 90.91c-5.81 6.78-7.06 15.99-3.27 24.04C37.97 283 45.93 288 54.95 288h30.63L5.69 378.49c-6 6.79-7.36 16.09-3.56 24.26 3.75 8.05 12 13.25 21.01 13.25H160v24.45l-30.29 48.4c-5.32 10.64 2.42 23.16 14.31 23.16h95.96c11.89 0 19.63-12.52 14.31-23.16L224 440.45V416h136.86c9.01 0 17.26-5.2 21.01-13.25 3.8-8.17 2.44-17.47-3.56-24.26z"
    ],
    viewBox: "0 0 384 512"
  },
  trees: {
    paths: [
      "M88.77,78.73H73.62v-6.57h15.83v-0.01c0.26,0,0.52-0.02,0.79-0.05c2-0.24,3.67-1.06,5.01-2.23 c1.3-1.14,2.19-2.54,2.71-4.01c0.48-1.39,0.63-2.89,0.46-4.31c-0.19-1.56-0.78-3.1-1.76-4.4c-0.1-0.14-0.21-0.27-0.32-0.41 l-1.38-1.61l-4.46-5.22c0.43-0.31,0.84-0.66,1.22-1.04c1.1-1.11,1.9-2.49,2.34-3.96c0.43-1.44,0.52-3.01,0.23-4.57 c-0.33-1.73-1.13-3.43-2.49-4.88L84,26.29l6.64-7.88c0.87-1.03,1.79-2.54,3.3-2.51c1.3,0.03,2.08,1.26,2.85,2.16l13.49,15.74 c1.47,2.1,0.21,4.31-2.33,4.31h-3.64l13.83,16.21c1.66,1.64,0.81,4.28-1.1,4.63H109l12.06,14.14l1.32,1.55 c1.01,1.16,0.5,3.79-1.67,4.05H98.97L88.77,78.73L88.77,78.73z",
      "M94.32,70.59c0.33-0.22,0.64-0.46,0.93-0.72c1.3-1.14,2.19-2.54,2.71-4.01c0.48-1.39,0.63-2.89,0.46-4.31 c-0.19-1.56-0.78-3.1-1.76-4.4c-0.1-0.14-0.21-0.27-0.32-0.41l-1.38-1.61l-0.64-0.75V43.85c0.2-1.1,0.2-2.25,0-3.39v-24.5 c1.08,0.23,1.78,1.3,2.46,2.12l13.49,15.74c1.47,2.1,0.21,4.31-2.33,4.31h-3.64l13.83,16.21c1.66,1.64,0.81,4.28-1.1,4.63H109 l12.06,14.14l1.32,1.55c1.01,1.16,0.5,3.79-1.67,4.05H98.97l-4.65,0.01V70.59L94.32,70.59z",
      "M35.14,65.38c-3.53,0.32-4.25-2.47-2.74-4.78l13.46-15.79l-0.39-0.39h-7.2c-2.61,0.38-3.58-2.44-1.99-4.43 l14.5-17.02h-4.24c-2.66,0.07-3.31-2.37-1.61-4.67L58.15,2.61c0.9-1.07,1.87-2.65,3.44-2.61c1.35,0.03,2.16,1.31,2.97,2.24 l14.04,16.38c1.52,2.19,0.22,4.49-2.43,4.49h-3.79l14.4,16.87c1.73,1.71,0.84,4.45-1.14,4.82h-8.37l12.54,14.74l1.38,1.61 c1.05,1.2,0.52,3.95-1.74,4.22C71.35,65.37,53.25,65.38,35.14,65.38L35.14,65.38z",
      "M61.62,0c1.33,0.05,2.14,1.31,2.94,2.24l14.04,16.38c1.52,2.19,0.22,4.49-2.43,4.49h-3.79l14.4,16.87 c1.73,1.71,0.84,4.45-1.14,4.82h-8.37l12.54,14.74l1.38,1.61c1.05,1.2,0.52,3.95-1.74,4.22l-27.83,0.01V0L61.62,0z",
      "M23.58,78.73H3.34c-3.39,0.31-4.08-2.36-2.63-4.59l12.94-15.16l-0.37-0.37H6.36 c-2.51,0.37-3.44-2.34-1.92-4.26l13.93-16.36h-4.06c-2.54,0.07-3.18-2.27-1.54-4.49l12.69-15.07c0.86-1.03,1.79-2.54,3.3-2.5 c1.3,0.03,2.08,1.26,2.85,2.16l7.26,8.47l-7.37,8.65c-0.18,0.18-0.35,0.37-0.51,0.57c-1.3,1.63-2.01,3.53-2.18,5.41 c-0.17,1.79,0.16,3.57,0.95,5.12c0.69,1.37,1.71,2.54,3.04,3.42l-5.51,6.46l0,0c-0.19,0.22-0.37,0.46-0.53,0.71 c-1.38,2.12-2,4.57-1.79,6.85c0.12,1.33,0.5,2.59,1.15,3.73c0.7,1.22,1.67,2.27,2.92,3.1c1.6,1.04,3.58,1.64,5.92,1.57 c0.07,0,0.14,0,0.21,0h14.29v6.57H33.79L23.58,78.73L23.58,78.73z",
      "M29.09,15.96c1.1,0.21,1.82,1.3,2.52,2.13l7.26,8.47l-7.37,8.65c-0.18,0.18-0.35,0.37-0.51,0.57 c-0.92,1.15-1.54,2.44-1.89,3.77V15.96L29.09,15.96z M29.09,44.62c0.16,0.59,0.38,1.16,0.66,1.7c0.69,1.37,1.71,2.54,3.04,3.42 l-3.69,4.33V44.62L29.09,44.62z M29.09,70.65c1.59,1.01,3.54,1.59,5.84,1.52c0.07,0,0.14,0,0.21,0H49.4v6.57H33.79l-4.7,0V70.65 L29.09,70.65z",
      "M12.73,106.95c-3.31,0-5.99-2.26-5.99-5.05c0-2.79,2.68-5.05,5.99-5.05c32.72,0,65.37-0.02,98.14-0.02 c3.21,0.1,5.77,2.32,5.77,5.04c0,2.79-2.68,5.05-5.99,5.05H12.73V106.95L12.73,106.95z"
    ],
    polygons: [
      "23.58,78.73 33.79,78.73 33.79,96.85 23.58,96.85 23.58,78.73",
      "56.21,65.39 66.83,65.39 66.83,96.85 56.21,96.85 56.21,65.39",
      "88.76,78.73 98.96,78.73 98.96,96.85 88.76,96.85 88.76,78.73"
    ],
    viewBox: "0 0 122.88 106.95"
  },
  heart: {
    paths: [
      "M340.8,83C307,83,276,98.8,256,124.8c-20-26-51-41.8-84.8-41.8C112.1,83,64,131.3,64,190.7c0,27.9,10.6,54.4,29.9,74.6 L245.1,418l10.9,11l10.9-11l148.3-149.8c21-20.3,32.8-47.9,32.8-77.5C448,131.3,399.9,83,340.8,83L340.8,83z"
    ],
    viewBox: "0 0 512 512"
  },
  gear: {
    paths: [
      "M462,280.72v-49.44l-46.414-16.48c-3.903-15.098-9.922-29.343-17.675-42.447l0.063-0.064l21.168-44.473l-34.96-34.96 l-44.471,21.167l-0.064,0.064c-13.104-7.753-27.352-13.772-42.447-17.673L280.72,50h-49.44L214.8,96.415 c-15.096,3.9-29.343,9.919-42.447,17.675l-0.064-0.066l-44.473-21.167l-34.96,34.96l21.167,44.473l0.066,0.064 c-7.755,13.104-13.774,27.352-17.675,42.447L50,231.28v49.44l46.415,16.48c3.9,15.096,9.921,29.343,17.675,42.447l-0.066,0.064 l-21.167,44.471l34.96,34.96l44.473-21.168l0.064-0.063c13.104,7.753,27.352,13.771,42.447,17.675L231.28,462h49.44l16.48-46.414 c15.096-3.903,29.343-9.922,42.447-17.675l0.064,0.063l44.471,21.168l34.96-34.96l-21.168-44.471l-0.063-0.064 c7.753-13.104,13.771-27.352,17.675-42.447L462,280.72z M256,338.4c-45.509,0-82.4-36.892-82.4-82.4c0-45.509,36.891-82.4,82.4-82.4 c45.509,0,82.4,36.891,82.4,82.4C338.4,301.509,301.509,338.4,256,338.4z"
    ],
    viewBox: "0 0 512 512"
  },
  vader: {
    paths: [
      "M 454.5779,419.82295 328.03631,394.69439 282.01503,515.21933 210.30518,407.97233 92.539234,460.65437 117.66778,334.11278 -2.8571457,288.09151 104.38984,216.38165 51.707798,98.615703 178.2494,123.74425 224.27067,3.2193247 295.98052,110.46631 413.74648,57.784277 388.61793,184.32587 509.14286,230.34714 401.89587,302.057 z"
    ],
    viewBox: "0 0 512 512"
  }
};

export const getMarkerUrl = ({
  id,
  fill,
  height = 50,
  width = 50
}: {
  id: string;
  width?: number;
  height?: number;
  fill: string;
}) => {
  const { paths, polygons = [], viewBox } = markerIcons[id];

  return `data:image/svg+xml;base64, ${window.btoa(
    `<svg fill="${fill}" height="${height}" viewBox="${viewBox}" width="${width}" xmlns="http://www.w3.org/2000/svg"><g>
    ${paths.map((d) => `<path d="${d}"/>`)}
    ${polygons.map((points) => `<polygon points="${points}"/>`)}
    </g></svg>`
  )}`;
};

export const getCity = (
  result: google.maps.places.PlaceResult | google.maps.GeocoderResult | string
) => {
  //console.log("getCity: result", result);
  let city = "Paris";

  if (typeof result === "string") return city;

  let found = false;

  result.address_components?.forEach(
    (address_component: google.maps.GeocoderAddressComponent) => {
      if (address_component.types.indexOf("locality") !== -1) {
        found = true;
        city = address_component.long_name || address_component.short_name;
      }
    }
  );

  if (!found)
    result.address_components?.forEach(
      (address_component: google.maps.GeocoderAddressComponent) => {
        if (
          address_component.types.indexOf("administrative_area_level_2") !== -1
        ) {
          city = address_component.long_name || address_component.short_name;
        }
      }
    );

  return city;
};

export const unwrapSuggestion = async (suggestion: Suggestion) => {
  //console.log("unwrapSuggestion: Suggestion", suggestion);

  // const placeResult = await getDetails({
  //   placeId: suggestion.place_id,
  //   fields: ["address_component"]
  // });
  // console.log("unwrapSuggestion: PlaceResult", placeResult);

  const results = await getGeocode({ address: suggestion.description });
  //console.log("unwrapSuggestion: GeocoderResult[]", results);

  const { lat, lng } = await getLatLng(results[0]);
  //console.log("unwrapSuggestion: lat, lng", lat, lng);

  const city = getCity(results[0]);
  //console.log("unwrapSuggestion: city", city);

  return { lat, lng, city };
};

const TILE_SIZE = 256;

export function latLng2World({ lat, lng }: LatLon) {
  const sin = Math.sin((lat * Math.PI) / 180);
  const x = lng / 360 + 0.5;
  let y = 0.5 - (0.25 * Math.log((1 + sin) / (1 - sin))) / Math.PI;

  y =
    y < -1 // .
      ? -1
      : y > 1
        ? 1
        : y;
  return { x, y };
}

export function world2Screen({ x, y }: { x: number; y: number }, zoom: number) {
  const scale = Math.pow(2, zoom);
  return {
    x: x * scale * TILE_SIZE,
    y: y * scale * TILE_SIZE
  };
}

const rad = function (x: number) {
  return (x * Math.PI) / 180;
};

export const getDistance = function (p1: LatLon, p2: LatLon) {
  const R = 6378137; // Earth's mean radius in meter
  const dLat = rad(p2.lat - p1.lat);
  const dLong = rad(p2.lng - p1.lng);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(rad(p1.lat)) *
      Math.cos(rad(p2.lat)) *
      Math.sin(dLong / 2) *
      Math.sin(dLong / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const d = R * c;
  return Math.round(d); // returns the distance in meter
};
